#!/usr/bin/env bash

# Author: Nam Nguyen <vnngucs@outlook.com>
# Description: Create symbolic links for Pixi environments' man1 pages.
# License: The Unlicense
# Date created: October 25, 2025
# Date modified: October 26, 2025 

pixi_path="${HOME}/.pixi"
pixi_man_path="${pixi_path}/man"
pixi_envs_path="${pixi_path}/envs"

_create_symlink() {
  local man_file="${1}"
  local man_section_path="${man_file/#*\/share\/man\//}"
  local source="${man_file}"
  local target="${pixi_man_path}/${man_section_path}"

  if [[ ! -e "${target}" ]]; then
    mkdir -p "$(dirname "${target}")"
    ln -s "${source}" "${target}"
  fi
}

_progress_bar() {
  local count="${1}"
  local total="${2}"

  local percent_done=$((count * 100 / total))
  local bar_char="|"
  local bar_total=50
  local bar_count=$((percent_done * bar_total / 100))

  local i
  local bars="["
  for ((i = 0; i < "${bar_count}"; i += 1)); do
    bars+="${bar_char}"
  done
  for ((i = "${bar_count}"; i < "${bar_total}"; i += 1)); do
    bars+=" "
  done
  bars+="]"

  echo -ne "${bars} ${count}/${total} (${percent_done}%)\r"
}

main() {
  rm -rf "${pixi_man_path}"

  man_files=("${pixi_envs_path}"/*/share/man/man1/*)
  man_file_total="${#man_files[@]}"

  for ((i = 0; i < "${man_file_total}"; i += 1)); do
    _progress_bar "$((i+1))" "${man_file_total}"
    _create_symlink "${man_files[i]}"
  done

  echo -e "\nCreated ${man_file_total} symlinks!"
}

main "$@"
