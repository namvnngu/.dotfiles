#!/usr/bin/env bash

RESOURCES_DIR="$HOME/dotfiles/bin/resources"
REQUESTED_CMD_PATH_FILE="$RESOURCES_DIR/cmd-$1"

if [[ $* == *ls* ]]; then
  categories=$(find $RESOURCES_DIR -maxdepth 1 -name "cmd*" | sed 's/^.*cmd-//')
  echo $categories
  exit 0
fi

###############################################################################

if [[ $# -eq 0 ]] ; then
  files=$(find $RESOURCES_DIR -maxdepth 1 -name "cmd*")
  selected=$(cat $files | fzf)
elif [[ -e $REQUESTED_CMD_PATH_FILE ]]; then
  selected=$(cat $REQUESTED_CMD_PATH_FILE | fzf)
else
  echo "$REQUESTED_CMD_PATH_FILE: No such file"
  exit 1
fi

if [[ -z $selected ]]; then
  exit 1
fi

selected_cmd=$(echo $selected | sed 's/^.*: //')
echo "Selected command: $selected_cmd"

###############################################################################

placeholders=$(echo $selected_cmd | grep -oE '<(\w|-)+>')
if [[ -n "$placeholders" ]]; then
  echo "----------------------"
  for phd in $placeholders; do
    read -p "$phd: " phd_value
    selected_cmd=$(echo $selected_cmd | sed "s/$phd/$phd_value/")
    echo "Command: $selected_cmd"
  done
  echo "----------------------"
fi

###############################################################################

while true; do
  read -p "copy (c) or execute (e)? " query
  query=$(echo $query | tr '[:upper:]' '[:lower:]')

  if [[ $query == c* ]]; then
    echo "Copied to clipboard: $selected_cmd"

    os=$(uname -s)
    case $os in
      Darwin*)
        echo $selected_cmd | pbcopy
        ;;
      Linux*)
        echo $selected_cmd | xclip -selection clipboard
        ;;
    esac
    exit 0
  elif [[ $query == e* ]]; then
    echo "Execute: $selected_cmd"
    echo "----------------------"
    eval $selected_cmd

    exit 0
  else
    echo "You should choose copy (c) or execute (e)"
  fi
done
