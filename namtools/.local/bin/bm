#!/usr/bin/env bash

# Author: Nam Nguyen <nguyenvietnam2401@gmail.com>
# Description: The URL bookmark manager (bm)
# License: MIT License
# Date created: July 02, 2025
# Date modified: December 01, 2025

# BOOKMARK FILE
#
# Each line in the bookmark file represents a single bookmark. Each bookmark has
# 3 fields: category, title, and URL. The fields separated by the '|' character.
#
# category|title|url

# GLOBALS

_cmd="$(basename "${0}")"
_version="0.1.1"

_bm_file="${NAMTOOLS_DATA_DIR}/bm.txt"
_bm_separator="|"

# UTILITIES FUNCTIONS

# Exits with status 1 and messages.
#
# Usage: _exit_1 [ARGUMENTS]
#
# Arguments:
#   [message]  Error message
_exit_1() {
  printf "%s: %s\n" "$(tput setaf 1)${_cmd} error$(tput sgr0)" "$*" >&2
  exit 1
}

# CORE FUNCTIONS

# Adds a bookmark.
#
# If one of the options is not provided, bm enters interactive mode and prompts
# to input the category, title, and/or URL. All options must be provided. In
# both cases, once the option values are provided, bm adds a new bookmark to
# the bookmark file using the format described above.The new bookmark is
# inserted in alphabetical order (Aâ€“Z).
#
# Usage: add-bm [OPTIONS]
#
# Options:
#   -c  Bookmark category
#   -t  Bookmark title
#   -u  Bookmark URL
add-bm() {
  read -r -p "Category: " category
  read -r -p "Title: " title
  read -r -p "URL: " url

  local bookmark="${category}${_bm_separator}${title}${_bm_separator}${url}"
  local bookmarks=$(cat "${_bm_file}")
  bookmarks="${bookmarks}\n${bookmark}"

  printf "${bookmarks}" | sort -f > "${_bm_file}"
}

# Opens a bookmark in browser.
#
# If no options are provided, bm enters interactive mode, and displays all
# bookmarks from the file using the fzf view. If one of the options is
# provided, bm attempts to find the matching bookmark, and exits if none is
# found. In both cases, once a bookmark is selected or found, its URL will be
# extracted and opened in your default browser.
#
# Usage: open-bm [OPTIONS]
#
# Options:
#   -l Line number
open-bm() {
  local bm=$(fzf < "${_bm_file}")
  local url=$(cut -d '|' -f 3 <<< "${bm}")
  opena "${url}"
}

# Copies a bookmark into clipboard.
#
# If no options are provided, bm enters interactive mode, and displays all
# bookmarks from the file using the fzf view. If one of the options is
# provided, bm attempts to find the matching bookmark, and exits if none is
# found. In both cases, once a bookmark is selected or found, its URL will be
# copied to clipboard.
#
# Usage: copy-bm [OPTIONS]
#
# Options:
#   -l Line number
copy-bm() {
  local bm=$(fzf < "${_bm_file}")
  local url=$(cut -d '|' -f 3 <<< "${bm}")
  pbcopy <<< "${url}"
}

# Removes a bookmark.
#
# If no options are provided, bm enters interactive mode, and displays all
# bookmarks from the file using the fzf view. If one of the options is
# provided, bm attempts to find the matching bookmark, and exits if none is
# found. In both cases, once a bookmark is selected or found, its URL will be
# removed from the bookmark file.
#
# Usage: rm-bm [OPTIONS]
#
# Options:
#   -l Line number
rm-bm() {
  echo "TODO: Remove bookmark"
}

# Prints the content of the bookmark file.
#
# Usage: view-bm
view-bm() {
  cat "${_bm_file}"
}

# Prints the usage information.
#
# Usage: help
help() {
  printf "${_cmd} - Manage your bookmarks

Version: ${_version}

Usage: ${_cmd} [OPTIONS] [COMMAND]

Commands:
  add         Add a bookmark
  open        Open a bookmark in browser
  copy, cp    Copy a bookmark into clipboard
  remove, rm  Remove a bookmark
  view        Print the content of the bookmark file
  help        Print usage information
 
Options: 
  -h, --help  Print usage information
"
}

# MAIN

main() {
  local subcmd="${1:-help}"
  case "${subcmd}" in
    add)
      add-bm
      ;;
    open)
      open-bm
      ;;
    copy | cp)
      copy-bm
      ;;
    remove | rm)
      rm-bm
      ;;
    view | list | ls)
      view-bm
      ;;
    help | --help | -h)
      help
      ;;
    *)
      _exit_1 "unknown command '${subcmd}'
For more information, try '${_cmd} help' or '${_cmd} -h'"
      ;;
  esac
}

main "$@"
