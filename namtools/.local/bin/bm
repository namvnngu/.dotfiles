#!/usr/bin/env bash

# Author: Nam Nguyen <vnngucs@outlook.com>
# Description: The URL bookmark manager (bm)
# License: The Unlicense
# Date created: July 02, 2025
# Date modified: November 25, 2025

# BOOKMARK FILE
#
# Each line in the bookmark file represents a single bookmark. Each bookmark has
# 3 fields: category, title, and URL. The fields separated by the '|' character.
#
# category|title|url

# GLOBALS

_cmd="$(basename "${0}")"
_version="0.1.0"

_bm_file="${NAMTOOLS_DATA_DIR}/bm.txt"
_bm_separator="|"

# UTILITIES FUNCTIONS

# Exits with status 1 and messages.
#
# Usage: _exit_1 [ARGUMENTS]
#
# Arguments:
#   [message]  Error message
_exit_1() {
  printf "%s: %s\n" "$(tput setaf 1)${_cmd} error$(tput sgr0)" "$*" >&2
  exit 1
}

# CORE FUNCTIONS

# Adds a bookmark.
#
# If one of the options is not provided, bm enters interactive mode and prompts
# to input the category, title, and/or URL. All options must be provided. In
# both cases, once the option values are provided, bm adds a new bookmark to
# the bookmark file using the format described above.The new bookmark is
# inserted in alphabetical order (Aâ€“Z).
#
# Usage: _add_bm [OPTIONS]
#
# Options:
#   -c  Bookmark category
#   -t  Bookmark title
#   -u  Bookmark URL
_add_bm() {
  read -r -p "Category: " category
  read -r -p "Title: " title
  read -r -p "URL: " url

  local bookmark="${category}${_bm_separator}${title}${_bm_separator}${url}"
  local bookmarks=$(cat "${_bm_file}")
  bookmarks="${bookmarks}\n${bookmark}"

  printf "${bookmarks}" | sort -f > "${_bm_file}"
}

# Opens a bookmark in browser.
#
# If no options are provided, bm enters interactive mode, and displays all
# bookmarks from the file using the fzf view. If one of the options is
# provided, bm attempts to find the matching bookmark, and exits if none is
# found. In both cases, once a bookmark is selected or found, its URL will be
# extracted and opened in your default browser.
#
# Usage: _open_bm [OPTIONS]
#
# Options:
#   -l Line number
_open_bm() {
  local bm=$(fzf < "${_bm_file}")
  local url=$(cut -d '|' -f 3 <<< "${bm}")
  opena "${url}"
}

# Copies a bookmark into clipboard.
#
# If no options are provided, bm enters interactive mode, and displays all
# bookmarks from the file using the fzf view. If one of the options is
# provided, bm attempts to find the matching bookmark, and exits if none is
# found. In both cases, once a bookmark is selected or found, its URL will be
# copied to clipboard.
#
# Usage: _copy_bm [OPTIONS]
#
# Options:
#   -l Line number
_copy_bm() {
  local bm=$(fzf < "${_bm_file}")
  local url=$(cut -d '|' -f 3 <<< "${bm}")
  pbcopy <<< "${url}"
}

# Removes a bookmark.
#
# If no options are provided, bm enters interactive mode, and displays all
# bookmarks from the file using the fzf view. If one of the options is
# provided, bm attempts to find the matching bookmark, and exits if none is
# found. In both cases, once a bookmark is selected or found, its URL will be
# removed from the bookmark file.
#
# Usage: _rm_bm [OPTIONS]
#
# Options:
#   -l Line number
_rm_bm() {
  echo "TODO: Remove bookmark"
}

# Prints the content of the bookmark file.
#
# Usage: _view_bm
_view_bm() {
  cat "${_bm_file}"
}

# Prints the usage information.
#
# Usage: _help
_help() {
  printf "${_cmd} - Manage your bookmarks

Usage: ${_cmd} [OPTIONS] [COMMAND]

Commands:
  add         Add a bookmark
  open        Open a bookmark in browser
  copy, cp    Copy a bookmark into clipboard
  remove, rm  Remove a bookmark
  view        Print the content of the bookmark file
  help        Print usage information
 
Options: 
  -h, --help  Print usage information
"
}

# MAIN

_main() {
  local subcmd="${1:-help}"
  case "${subcmd}" in
    add)
      _add_bm
      ;;
    open)
      _open_bm
      ;;
    copy | cp)
      _copy_bm
      ;;
    remove | rm)
      _rm_bm
      ;;
    view | list | ls)
      _view_bm
      ;;
    help | --help | -h)
      _help
      ;;
    *)
      _exit_1 "unknown command '${subcmd}'
For more information, try '${_cmd} help' or '${_cmd} -h'"
      ;;
  esac
}

_main "$@"
